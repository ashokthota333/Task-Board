<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Secure Family Task Board</title>
<style>
:root{
  --bg:#f4f6fb;
  --card:#ffffff;
  --primary:#6366f1;
  --success:#22c55e;
  --warning:#f59e0b;
  --danger:#ef4444;
  --text:#111827;
  --muted:#6b7280;
  --radius:16px;
}

body{
  margin:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont;
  background:var(--bg);
  color:var(--text);
}

header{
  background:linear-gradient(135deg,#6366f1,#4f46e5);
  color:white;
  padding:1rem;
  text-align:center;
  font-weight:600;
  display:flex;
  flex-direction:column;
  gap:.5rem;
  align-items:center;
}

.clock{
  display:flex;
  gap:1rem;
  font-size:0.85rem;
  font-weight:500;
}

#filters,#statusFilters{
  display:flex;
  gap:.5rem;
  padding:.75rem;
  overflow-x:auto;
}

.filter{
  padding:.45rem .9rem;
  border-radius:999px;
  background:#e5e7eb;
  cursor:pointer;
  font-size:.85rem;
  white-space:nowrap;
  transition:.2s;
  position:relative;
}
.filter .count{
  font-size:0.7rem;
  background:#d1d5db;
  padding:0 .3rem;
  border-radius:999px;
  margin-left:.3rem;
}

.filter.active{
  background:var(--primary);
  color:white;
}

#actions{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:.5rem 1rem;
  flex-wrap:wrap;
  gap:.5rem;
}

button{
  border:none;
  border-radius:12px;
  padding:.45rem .8rem;
  font-size:.85rem;
  cursor:pointer;
  transition:.2s;
}
button:hover{opacity:.9}

.primary{background:var(--primary);color:white;}
.secondary{background:#e5e7eb;}
.dangerBtn{background:var(--danger);color:white;}

#tasks{
  padding:1rem;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:1rem;
}

.task{
  background:var(--card);
  border-radius:var(--radius);
  padding:1rem;
  box-shadow:0 6px 16px rgba(0,0,0,.08);
  transition:.2s;
  position:relative;
}

.task.low{border-left:6px solid var(--warning);}
.task.medium{border-left:6px solid orange;}
.task.high{border-left:6px solid var(--danger);}
.task.done{border-left:6px solid var(--success); opacity:.55; text-decoration:line-through;}

.meta{
  font-size:.8rem;
  color:var(--muted);
  margin-top:.2rem;
}

.task button{
  margin-top:.4rem;
  margin-right:.3rem;
}

.priority-bar{
  height:6px;
  border-radius:3px;
  margin-top:4px;
}

.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:10;
}

.panel{
  background:white;
  width:90%;
  max-width:360px;
  border-radius:20px;
  padding:1rem;
  animation:slide .2s ease-out;
}

@keyframes slide{
  from{transform:translateY(20px);opacity:0}
  to{transform:none;opacity:1}
}

label{
  display:block;
  font-size:.8rem;
  margin:.6rem 0 .2rem;
}

input,select{
  width:100%;
  padding:.45rem;
  border-radius:10px;
  border:1px solid #d1d5db;
}

.toast{
  position:fixed;
  bottom:1rem;
  left:50%;
  transform:translateX(-50%);
  background:var(--success);
  color:white;
  padding:.4rem .9rem;
  border-radius:999px;
  font-size:.85rem;
  z-index:20;
  animation:fadeIn 0.3s;
}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}

#reportCard{
  margin:1rem;
  padding:1rem;
  background:white;
  border-radius:16px;
  box-shadow:0 6px 16px rgba(0,0,0,.08);
}

#reportCard h3{
  margin-top:0;
}

</style>
</head>
<body>

<header>
  üîê Secure Family Task Board
  <div class="clock">
    <div>üáÆüá≥ IST: <span id="istClock"></span></div>
    <div>üá©üá™ CET: <span id="gerClock"></span></div>
  </div>
</header>

<div id="loginPanel" class="overlay" style="display:flex;">
  <div class="panel">
    <h3>Enter Passphrase</h3>
    <input type="password" id="passphrase" placeholder="Enter your passphrase">
    <br><br>
    <button class="primary" onclick="initApp()">Enter</button>
  </div>
</div>

<div id="filters"></div>
<div id="statusFilters" style="display:none;"></div>

<div id="actions" style="display:none;">
  <button class="secondary" onclick="openUserPanel()">Manage Users</button>
  <div style="display:flex;gap:.5rem;flex-wrap:wrap;">
    <button class="secondary" onclick="openTaskPanel()">‚ûï Task</button>
    <button class="primary" onclick="save()">üíæ Save</button>
    <button class="secondary" onclick="openLog()">üìú Log</button>
  </div>
</div>

<div id="tasks"></div>

<div id="reportCard"></div>

<!-- Task Panel -->
<div class="overlay" id="taskOverlay">
  <div class="panel">
    <h3>Add / Edit Task</h3>
    <label>Task name</label>
    <input id="tTitle">
    <label>Assign to (multi-select)</label>
    <select id="tUser" multiple></select>
    <label>Due date (optional)</label>
    <input type="datetime-local" id="tDue">
    <label>Priority</label>
    <select id="tPriority">
      <option value="low">Low</option>
      <option value="medium">Medium</option>
      <option value="high">High</option>
    </select>
    <br><br>
    <button class="primary" onclick="addOrEditTask()">Save Task</button>
    <button class="secondary" onclick="closePanels()">Cancel</button>
  </div>
</div>

<!-- User Panel -->
<div class="overlay" id="userOverlay">
  <div class="panel">
    <h3>Manage Users</h3>
    <label>User name</label>
    <input id="uName">
    <label>Select user</label>
    <select id="selectUser"></select>
    <br><br>
    <button class="primary" onclick="addUser()">Add User</button>
    <button class="dangerBtn" onclick="deleteUser()">Delete Selected User</button>
    <button class="secondary" onclick="closePanels()">Cancel</button>
  </div>
</div>

<!-- Log Panel -->
<div class="overlay" id="logOverlay">
  <div class="panel">
    <h3>Action Log</h3>
    <div id="logContent" style="max-height:400px;overflow:auto;"></div>
    <br>
    <button class="secondary" onclick="closeLog()">Close</button>
  </div>
</div>

<script>
let STATE={users:[],tasks:[],log:[]};
let filter="All";
let statusFilter="all";
let key,gistId,token;
let editTaskIndex=null;

// ----- Clocks -----
function updateClocks(){
  const now = new Date();
  document.getElementById("istClock").textContent =
    now.toLocaleTimeString("en-IN",{hour12:false,timeZone:"Asia/Kolkata"});
  document.getElementById("gerClock").textContent =
    now.toLocaleTimeString("de-DE",{hour12:false,timeZone:"Europe/Berlin"});
}
setInterval(updateClocks,1000);
updateClocks();

// ----- Encryption helpers -----
async function getKey(passphrase){
  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey("raw", enc.encode(passphrase), {name:"PBKDF2"}, false, ["deriveKey"]);
  return crypto.subtle.deriveKey(
    {name:"PBKDF2", salt:enc.encode("familyTaskSalt"), iterations:250000, hash:"SHA-256"},
    keyMaterial,
    {name:"AES-GCM", length:256},
    false,
    ["encrypt","decrypt"]
  );
}
async function encryptData(obj){
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const data = new TextEncoder().encode(JSON.stringify(obj));
  const cipher = await crypto.subtle.encrypt({name:"AES-GCM",iv},key,data);
  return btoa(String.fromCharCode(...iv))+":"+btoa(String.fromCharCode(...new Uint8Array(cipher)));
}
async function decryptData(str){
  const [ivStr,cipherStr] = str.split(":");
  const iv = Uint8Array.from(atob(ivStr),c=>c.charCodeAt(0));
  const cipher = Uint8Array.from(atob(cipherStr),c=>c.charCodeAt(0));
  const plain = await crypto.subtle.decrypt({name:"AES-GCM",iv},key,cipher);
  return JSON.parse(new TextDecoder().decode(plain));
}

// ----- Render Filters and Counts -----
function renderFilters(){
  const f=document.getElementById("filters");
  f.innerHTML="";
  STATE.users.forEach(u=>{
    const count = STATE.tasks.filter(t=>t.assigned.includes(u.name)).length;
    const d=document.createElement("div");
    d.className="filter"+(u.name===filter?" active":"");
    d.innerHTML=`${u.name} <span class="count">${count}</span>`;
    d.onclick=()=>{filter=u.name;render();}
    f.appendChild(d);
  });
  const allCount = STATE.tasks.length;
  const allFilter=document.createElement("div");
  allFilter.className="filter"+("All"===filter?" active":"");
  allFilter.innerHTML=`All <span class="count">${allCount}</span>`;
  allFilter.onclick=()=>{filter="All";render();}
  f.prepend(allFilter);
}

function renderStatusFilters(){
  const f=document.getElementById("statusFilters");
  f.style.display="flex";
  f.innerHTML="";
  ["all","pending","done"].forEach(s=>{
    const d=document.createElement("div");
    d.className="filter"+(s===statusFilter?" active":"");
    d.textContent=s.charAt(0).toUpperCase()+s.slice(1);
    d.onclick=()=>{statusFilter=s;render();}
    f.appendChild(d);
  });
}

// ----- Render Tasks -----
function formatTimeISO(d){
  const dt = new Date(d);
  const ist = dt.toLocaleString("en-IN",{timeZone:"Asia/Kolkata"});
  const ger = dt.toLocaleString("de-DE",{timeZone:"Europe/Berlin"});
  return `${ist} / ${ger}`;
}

function renderTasks(){
  const t=document.getElementById("tasks");
  t.innerHTML="";
  STATE.tasks.filter(x=>
    (filter==="All"|| x.assigned.includes(filter)) &&
    (statusFilter==="all"|| (statusFilter==="done"&&x.done) || (statusFilter==="pending"&&!x.done))
  ).forEach((x,i)=>{
    const d=document.createElement("div");
    d.className=`task ${x.priority} ${x.done?"done":""}`;
    const usersHtml = x.assigned.map(u=>{
      const icon = STATE.users.find(us=>us.name===u)?.type==="man"?"üë®":
                   STATE.users.find(us=>us.name===u)?.type==="woman"?"üë©":"üßí";
      return `${icon} ${u}`;
    }).join(", ");
    d.innerHTML=`
      <strong>${x.title}</strong>
      <div class="meta">üë§ ${usersHtml||"Unassigned"}</div>
      <div class="meta">üìÖ ${x.due?formatTimeISO(x.due):"‚Äî"}</div>
      <div class="priority-bar" style="background:${x.done?'var(--success)':x.priority==='low'?'yellow':x.priority==='medium'?'orange':'red'}"></div>
      <button class="secondary">${x.done?"Undo":"Done"}</button>
      <button class="primary">Edit</button>
      <button class="dangerBtn">Delete</button>
    `;
    d.querySelectorAll("button")[0].onclick=()=>{x.done=!x.done;logAction(`Task '${x.title}' ${x.done?"completed":"marked pending"}`, x.assigned);render();}
    d.querySelectorAll("button")[1].onclick=()=>{openTaskPanel(i);}
    d.querySelectorAll("button")[2].onclick=async()=>{
      if(!confirm("Are you sure to delete? (1/2)")) return;
      if(!confirm("Confirm deletion? (2/2)")) return;
      logAction(`Task '${x.title}' deleted`, x.assigned);
      STATE.tasks.splice(i,1);render();
    }
    t.appendChild(d);
  });
}

// ----- Render Report -----
function renderReport(){
  const total = STATE.tasks.length;
  const completed = STATE.tasks.filter(t=>t.done).length;
  const pending = total-completed;
  const perUser={};
  STATE.users.forEach(u=>{perUser[u.name]=0;});
  STATE.tasks.forEach(t=>t.assigned.forEach(u=>{if(perUser[u]!==undefined) perUser[u]++;}));
  const perPriority={low:0,medium:0,high:0};
  STATE.tasks.forEach(t=>perPriority[t.priority]++);
  const reportDiv=document.getElementById("reportCard");
  reportDiv.innerHTML=`
    <h3>Report Card</h3>
    <div>Total tasks: ${total}</div>
    <div>Completed: ${completed}</div>
    <div>Pending: ${pending}</div>
    <div>Tasks per user: ${JSON.stringify(perUser)}</div>
    <div>Tasks per priority: ${JSON.stringify(perPriority)}</div>
  `;
}

// ----- Render Filters + Tasks + Report -----
function render(){renderFilters(); renderStatusFilters(); renderTasks(); renderReport(); renderLog();}

// ----- Panels -----
function openTaskPanel(index=null){
  editTaskIndex=index;
  tTitle.value=index!==null?STATE.tasks[index].title:"";
  tDue.value=index!==null?STATE.tasks[index].due:"";
  tPriority.value=index!==null?STATE.tasks[index].priority:"low";
  const s=document.getElementById("tUser");
  s.innerHTML="";
  STATE.users.forEach(u=>{if(u.name!=="All"){const o=document.createElement("option"); o.value=u.name; o.textContent=u.name; if(index!==null && STATE.tasks[index].assigned.includes(u.name)) o.selected=true; s.appendChild(o);}});
  taskOverlay.style.display="flex";
}

function addOrEditTask(){
  const assigned=[...tUser.selectedOptions].map(o=>o.value);
  if(!tTitle.value.trim()) return;
  const taskObj={title:tTitle.value.trim(),assigned,due:tDue.value,priority:tPriority.value,done:editTaskIndex!==null?STATE.tasks[editTaskIndex].done:false};
  if(editTaskIndex!==null){
    logAction(`Task '${STATE.tasks[editTaskIndex].title}' edited`, assigned);
    STATE.tasks[editTaskIndex]=taskObj;
  } else {STATE.tasks.push(taskObj); logAction(`Task '${taskObj.title}' added`, assigned);}
  closePanels();
  render();
}

function openUserPanel(){
  uName.value="";
  const sel=document.getElementById("selectUser");
  sel.innerHTML="";
  STATE.users.forEach(u=>{if(u.name!=="All"){const o=document.createElement("option"); o.value=u.name; o.textContent=u.name; sel.appendChild(o);}});
  userOverlay.style.display="flex";
}

function closePanels(){taskOverlay.style.display="none"; userOverlay.style.display="none"; logOverlay.style.display="none";}

// ----- Users -----
function addUser(){const n=uName.value.trim(); if(!n || STATE.users.find(u=>u.name===n)) return; STATE.users.push({name:n,type:"man"}); logAction(`User '${n}' added`); closePanels(); render();}
function deleteUser(){const sel=document.getElementById("selectUser"); const n=sel.value; if(!n) return; if(!confirm(`Delete user ${n}?`)) return; STATE.users=STATE.users.filter(u=>u.name!==n); STATE.tasks.forEach(t=>t.assigned=t.assigned.filter(u=>u!==n)); logAction(`User '${n}' deleted`); closePanels(); render();}

// ----- Log -----
function logAction(action, users=[]){const now=new Date().toISOString(); STATE.log.push({timestamp:now,action,users}); renderLog();}
function renderLog(){const logDiv=document.getElementById("logContent"); logDiv.innerHTML=STATE.log.map(l=>{const dateIST=new Date(l.timestamp).toLocaleString("en-IN",{timeZone:"Asia/Kolkata"}); const dateGER=new Date(l.timestamp).toLocaleString("de-DE",{timeZone:"Europe/Berlin"}); return `<div>üïí ${dateIST} / ${dateGER} - ${l.action} [${l.users.join(", ")}]</div>`;}).join("");}
function openLog(){logOverlay.style.display="flex";}
function closeLog(){logOverlay.style.display="none";}

// ----- GitHub Gist -----
async function fetchGist(){const resp=await fetch(`https://api.github.com/gists/${gistId}`);const data=await resp.json();const encContent=Object.values(data.files)[0].content; STATE=await decryptData(encContent);}
async function save(){const encContent=await encryptData(STATE); if(!token){alert("GitHub token missing. Cannot save online!"); return;} await fetch(`https://api.github.com/gists/${gistId}`,{method:"PATCH",headers:{Authorization:"token "+token},body:JSON.stringify({files:{[gistId+".txt"]:{content:encContent}}})}); const t=document.createElement("div"); t.className="toast"; t.textContent="Saved ‚úî"; document.body.appendChild(t); setTimeout(()=>t.remove(),2000);}

// ----- Initialize App -----
async function initApp(){
  const p=document.getElementById("passphrase").value.trim();
  if(!p){alert("Enter passphrase");return;}
  const parts=p.split(" ");
  if(parts.length<3){alert("Passphrase format: key gistID token");return;}
  const [passKey,gId,tok]=parts;
  gistId=gId; token=tok;
  key=await getKey(passKey);
  try{await fetchGist();}catch(e){alert("Failed to fetch Gist. Ensure the secret Gist exists and passphrase is correct."); return;}
  document.getElementById("loginPanel").style.display="none";
  document.getElementById("actions").style.display="flex";
  document.getElementById("statusFilters").style.display="flex";
  render();
  setInterval(async()=>{try{await fetchGist(); render();}catch(e){console.warn("Auto-refresh failed");}},10000);
}
</script>
</body>
</html>
